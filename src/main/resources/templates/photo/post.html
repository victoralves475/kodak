<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" layout:decorate="~{/layout/layout}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" th:with="title='Publicação'">
<head>
  <title>Publicação</title>
  <link rel="stylesheet" th:href="@{/css/output.css}" />
</head>
<body>
<div layout:fragment="content" class="p-4">
  <!-- Seção da publicação -->
  <div class="bg-gray-100 w-auto mx-10 grid grid-cols-1 md:grid-cols-[2fr_1fr] gap-2" style="min-height: 750px">
    <!-- Imagem da publicação -->
    <div class="flex items-center justify-center">
      <img th:src="@{${photo.path}}" alt="Post Image" class="object-cover h-full w-auto" />
    </div>
    <!-- Área de comentários -->
    <div class="bg-white px-8 pt-8 shadow-md">
      <!-- Informações do fotógrafo -->
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center space-x-3">
          <img th:src="@{${photo.photographer.profilePicPath}}" alt="User Avatar" class="w-10 h-10 rounded-full" />
          <span class="font-semibold text-gray-800" th:text="${photo.photographer.name}"></span>
        </div>
        <div class="text-gray-500 cursor-pointer">
          <button class="p-1 hover:bg-gray-200 rounded-full">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="5" r="1" />
              <circle cx="12" cy="12" r="1" />
              <circle cx="12" cy="19" r="1" />
            </svg>
          </button>
        </div>
      </div>

      <!-- Descrição e hashtags -->
      <div class="mb-4">
        <p class="text-gray-800" th:text="${photo.description}"></p>
        <div th:each="hashtag : ${photo.tags}">
          <a href="#" class="text-blue-600" th:text="${hashtag.tagName}"></a>
        </div>
      </div>

      <!-- Seção de curtidas -->
      <div class="flex items-center text-gray-500 mb-4">
        <form th:action="@{/photo/like}" method="post">
          <input type="hidden" name="photoId" th:value="${photo.id}" />
          <button type="submit" class="flex items-center gap-1 p-1 hover:bg-gray-200 rounded-full">
            <svg class="w-5 h-5 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
              <path d="M12 21.35l-1.45-1.32C6.11 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-4.11 6.86-8.55 11.54L12 21.35z"/>
            </svg>
          </button>
        </form>
        <span th:text="${#lists.size(photo.likedPhotographers)}"></span>
        <span> Curtidas</span>
      </div>

      <hr class="mb-4" />

      <!-- Seção de Comentários -->
      <div class="mb-4">
        <p class="font-semibold text-gray-800 mb-2">Comentários</p>
        <div class="space-y-4" th:each="comment : ${photo.comments}">
          <div class="flex items-start space-x-3">
            <img th:src="@{${comment.photographer.profilePicPath}}" alt="Avatar" class="w-8 h-8 rounded-full" />
            <div class="flex-1">
              <div class="flex items-center justify-between">
                <span class="font-semibold text-gray-800" th:text="${comment.photographer.name}"></span>
                <span class="text-xs text-gray-500" th:text="${#temporals.format(comment.createdAt,'dd/MM/yyyy HH:mm')}"></span>
              </div>
              <p class="text-gray-700" th:text="${comment.commentText}"></p>
              <div class="flex space-x-2 mt-1" th:if="${comment.photographer.id == loggedPhotographer.id or isAdmin}">
                <button type="button" class="text-blue-600 text-xs hover:underline" th:onclick="|enableEdit(${comment.id})|">Editar</button>
                <button type="button" class="text-red-600 text-xs hover:underline" th:onclick="|confirmDelete(${comment.id})|">Excluir</button>
              </div>
              <!-- Formulário de edição inline (oculto por padrão) -->
              <div th:id="|edit-container-${comment.id}|" class="hidden mt-2">
                <form th:action="@{/comment/update/{id}(id=${comment.id})}" method="post" onsubmit="return confirmEmptyComment(this)" class="flex flex-col gap-2">
                  <textarea name="commentText" rows="2" class="w-full p-2 border rounded" th:text="${comment.commentText}"></textarea>
                  <div class="flex justify-end space-x-2">
                    <button type="submit" class="px-2 py-1 text-xs bg-blue-600 text-white rounded">Salvar</button>
                    <button type="button" class="px-2 py-1 text-xs bg-gray-600 text-white rounded" th:onclick="|disableEdit(${comment.id})|">Cancelar</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Seção de novo comentário -->
      <div class="mt-4" th:if="${!loggedPhotographer.commentSuspended}">
        <form th:action="@{/comment/new}" method="post">
          <input type="hidden" name="photoId" th:value="${photo.id}" />
          <textarea name="commentText" rows="3" class="w-full p-2 border rounded-lg" placeholder="Adicione um comentário..."></textarea>
          <div class="flex justify-end mt-2">
            <button type="submit" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Enviar</button>
          </div>
        </form>
      </div>
      <div class="mt-4 text-center text-red-600 font-semibold" th:if="${loggedPhotographer.commentSuspended}">
        Sua conta está suspensa para comentar.
      </div>
    </div>
  </div>
</div>

<!-- Funções JavaScript inline -->
<script type="text/javascript">
  function enableEdit(commentId) {
    var container = document.getElementById("edit-container-" + commentId);
    if (container) {
      container.classList.remove("hidden");
    }
  }

  function disableEdit(commentId) {
    var container = document.getElementById("edit-container-" + commentId);
    if (container) {
      container.classList.add("hidden");
    }
  }

  function confirmDelete(commentId) {
    if (confirm("Deseja realmente excluir este comentário?")) {
      window.location.href = "/comment/delete/" + commentId;
    }
  }

  function confirmEmptyComment(form) {
    var textarea = form.querySelector("textarea[name='commentText']");
    if (textarea.value.trim() === "") {
      return confirm("Comentário vazio será excluído. Confirmar?");
    }
    return true;
  }
</script>

</body>
</html>
